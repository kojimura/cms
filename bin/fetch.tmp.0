#!/bin/bash -euvx
source "$(dirname $0)/conf"
exec 2> "$logdir/$(basename $0).$(date +%Y%m%d_%H%M%S).$$"
[ -n "${CONTENT_LENGTH}" ] && dd bs=${CONTENT_LENGTH} > /dev/null
tmp=/tmp/$$

echo -e 'Content-type: text/html\n'

cd "$contentsdir"
git fetch origin master
git diff --name-status HEAD origin/master | 
grep -Eo '(posts|pages)/[^/]+'            |
sort -u                                   > $tmp-git-change

date
echo "pull from github"
git pull

[ -f "$datadir/INIT" ] &&
find posts pages -type d                |
grep -Eo '(posts|pages)/[^/]+'          > $tmp-git-change

rm -f "$datadir/INIT"
# cat $tmp-git-change > /tmp/diff 
date
echo "create/delete article derectory"
### CREATE/DELETE ARTICLE DIRECTORY ###
cat $tmp-git-change |
while read d; do
  [ -f "$contentsdir/$d/main.md" ] || rm -Rf "$datadir/$d"
  [ -f "$contentsdir/$d/main.md" ] || continue

  mkdir -p "$datadir/$d" &&
  ### ADD TIME FILES ###
  git log -p "$contentsdir/$d/main.md"  |
  grep '^Date:'                         |
  awk '{print $2,$3,$4,$5,$6}'          |
  date -f - "+%Y-%m-%d %H:%M:%S"        |
  awk -v cf="$datadir/$d/created_time" \
    -v mf="$datadir/$d/modified_time" \
    'NR==1{print > mf}END{print > cf}'

  ### MAKE SOME SNIPS ###
  grep -m 1 '^#' "$contentsdir/$d/main.md"        |
    sed 's/^# *//'                                |
    awk '{if(/^$/){print "NO TITLE"}else{print}}
     END{if(NR==0){print "NO TITLE"}}'            |
    tee "$datadir/$d/title"                       |
    awk -v d="$d" '{gsub(/s\//,"=",d);
     print "<a href=\"/?" d "\">" $0 "</a>"}' > "$datadir/$d/link"

  ymd=$(sed 's/ .*//' < "$datadir/$d/created_time")
  sed "s;</a>; ($ymd)&;" "$datadir/$d/link" > "$datadir/$d/link_date"

  touch "$datadir/$d/nav"
done
